<html>

<head>
  <title>OB</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <link rel="stylesheet" type="text/css" href="/js/semantic.min.css">
  <script src="/js/jquery.js"></script>
  <script src="/js/semantic.min.js"></script>
  <script src="/js/app.js"></script>
</head>

<body>


  <div class="ui stackable padded two column grid">
    <div class="row">
      <div class="four wide column">
    
            <div class="ui top attached tabular menu">
                <a class="item active" data-tab="first">Piyasa</a>
                <a class="item" data-tab="second">Limit</a>
                <a class="item" data-tab="third">Stop</a>
              </div>
              <div class="ui bottom attached tab segment active" data-tab="first">

                  <div id="piyasa">

                  <div class="ui secondary menu">
                      <a class="item active" data-tab="piyasa-alis">ALIŞ</a>
                      <a class="item" data-tab="piyasa-satis">SATIŞ</a>
                  </div>

                  <div class="ui tab active" data-tab="piyasa-alis">

                    <div class="ui right labeled input">
                          <label for="amount" class="ui label">TRY</label>
                          <input type="text" placeholder="Miktar" id="piyasa-alis-try">
                          <div class="ui basic label">.00</div>
                    </div>

                    <div class="row" style="margin-top:1em">
                      <button class="ui button primary" id="piyasa-alis-emri">Alış Emri Gir</button>
                    </div>

                  </div>

                    <div class="ui tab" data-tab="piyasa-satis">

                      <div class="row">
                        <div class="ui right labeled input">
                            <label for="amount" class="ui label">BTC</label>
                            <input type="text" placeholder="Miktar" id="piyasa-satis-btc">
                            <div class="ui basic label">.00</div>
                        </div>
                      </div>

                      <div class="row" style="margin-top:1em">
                        <button class="ui button primary" id="piyasa-satis-emri">Satış Emri Gir</button>
                      </div>

                    </div>

                  </div>

              </div>
              <div class="ui bottom attached tab segment" data-tab="second">
                
                  <div id="limit">

                      <div class="ui secondary menu">
                          <a class="item active" data-tab="limit-alis">ALIŞ</a>
                          <a class="item" data-tab="limit-satis">SATIŞ</a>
                      </div>
    
                      <div class="ui tab active" data-tab="limit-alis">
    
                          <div class="ui right labeled input">
                              <input type="text" placeholder="Fiyat" id="limit-alis-fiyat">
                              <div class="ui basic label">
                                BTC/TRY
                              </div>
                            </div>
    
                            <div class="row" style="margin-top:1em">
                            <div class="ui right labeled input">
                                <input type="text" placeholder="Miktar" id="limit-alis-miktar">
                                <div class="ui basic label">
                                  BTC
                                </div>
                              </div>
                            </div>

                          <div class="row" style="margin-top:1em">
                            <button class="ui button primary" id="limit-alis-emri">Alış Emri Gir</button>
                          </div>
    
                      </div>
    
                        <div class="ui tab" data-tab="limit-satis">
    
                            <div class="ui right labeled input">
                                <input type="text" placeholder="Fiyat" id="limit-satis-fiyat">
                                <div class="ui basic label">
                                  BTC/TRY
                                </div>
                              </div>
      
                              <div class="row" style="margin-top:1em">
                              <div class="ui right labeled input">
                                  <input type="text" placeholder="Miktar" id="limit-satis-miktar">
                                  <div class="ui basic label">
                                    BTC
                                  </div>
                                </div>
                              </div>
  
                            <div class="row" style="margin-top:1em">
                              <button class="ui button primary" id="limit-satis-emri">Satış Emri Gir</button>
                            </div>
                          
                        </div>
    
                      </div>


              </div>
              <div class="ui bottom attached tab segment" data-tab="third">
                
                  <div id="stop">

                      <div class="ui secondary menu">
                          <a class="item active" data-tab="stop-alis">ALIŞ</a>
                          <a class="item" data-tab="stop-satis">SATIŞ</a>
                      </div>
    
                      <div class="ui tab active" data-tab="stop-alis">

                          <div id="stop-alis">
                          
                            <div class="ui secondary menu">
                                <a class="item active" data-tab="piyasa-stop-alis">Piyasa</a>
                                <a class="item" data-tab="limit-stop-alis">Limit</a>
                            </div>

                            <div class="ui tab active" data-tab="piyasa-stop-alis">
                            
                              <div class="ui right labeled input">
                                    <input type="text" placeholder="Tetiklenme Fiyatı" id="piyasa-stop-alis-trigger">
                                    <div class="ui basic label">BTC/TRY</div>
                              </div>

                              <div class="row" style="margin-top:1em">

                                <div class="ui right labeled input">
                                    <label for="amount" class="ui label">TRY</label>
                                    <input type="text" placeholder="Miktar" id="piyasa-stop-alis-miktar">
                                    <div class="ui basic label">.00</div>
                                </div>

                              </div>
          
                              <div class="row" style="margin-top:1em">
                                <button class="ui button primary" id="piyasa-stop-alis-emri">Alış Emri Gir</button>
                              </div>

                            </div>
                      
                            <div class="ui tab" data-tab="limit-stop-alis">
                                
                                <div class="ui right labeled input">
                                    <input type="text" placeholder="Tetiklenme Fiyatı" id="limit-stop-alis-trigger">
                                    <div class="ui basic label">
                                      BTC/TRY
                                    </div>
                                  </div>

                                  <div class="row" style="margin-top:1em">

                                <div class="ui right labeled input">
                                    <input type="text" placeholder="Fiyat"  id="limit-stop-alis-fiyat">
                                    <div class="ui basic label">
                                      BTC/TRY
                                    </div>
                                  </div>
                                  </div>
          
                                  <div class="row" style="margin-top:1em">

                                  <div class="ui right labeled input">
                                      <input type="text" placeholder="Miktar" id="limit-stop-alis-miktar">
                                      <div class="ui basic label">
                                        BTC
                                      </div>
                                    </div>
                                  </div>
      
                                <div class="row" style="margin-top:1em">
                                  <button class="ui button primary"  id="limit-stop-alis-emri">Alış Emri Gir</button>
                                </div>


                            </div>

                          </div>

                      </div>
    
                        <div class="ui tab" data-tab="stop-satis">
    
                            <div id="stop-satis">
                          
                                <div class="ui secondary menu">
                                    <a class="item active" data-tab="piyasa-stop-satis">Piyasa</a>
                                    <a class="item" data-tab="limit-stop-satis">Limit</a>
                                </div>
    
                                <div class="ui tab active" data-tab="piyasa-stop-satis">
                                    
                                        <div class="ui right labeled input">
                                            <input type="text" placeholder="Tetiklenme Fiyatı" id="piyasa-stop-satis-trigger">
                                            <div class="ui basic label">
                                              BTC/TRY
                                            </div>
                                          </div>
                                          <div class="row" style="margin-top:1em">

                                        <div class="ui right labeled input">
                                            <label for="amount" class="ui label">BTC</label>
                                            <input type="text" placeholder="Miktar" id="piyasa-stop-satis-miktar">
                                            <div class="ui basic label">.00</div>
                                        </div>
                                      </div>
                
                                      <div class="row" style="margin-top:1em">
                                        <button class="ui button primary" id="piyasa-stop-satis-emri">Satış Emri Gir</button>
                                      </div>


                                </div>
                          
                                <div class="ui tab" data-tab="limit-stop-satis">
                                   

                                    <div class="ui right labeled input">
                                        <input type="text" placeholder="Tetiklenme Fiyatı" id="limit-stop-satis-trigger">
                                        <div class="ui basic label">
                                          BTC/TRY
                                        </div>
                                      </div>
                                  
                                      <div class="row" style="margin-top:1em">
                                      <div class="ui right labeled input">
                                          <input type="text" placeholder="Fiyat" id="limit-stop-satis-fiyat">
                                          <div class="ui basic label">
                                            BTC/TRY
                                          </div>
                                        </div>
                                    </div>
              
                                    <div class="row" style="margin-top:1em">
                                      
                                      <div class="ui right labeled input">
                                        <input type="text" placeholder="Miktar" id="limit-stop-satis-miktar">
                                        <div class="ui basic label">BTC</div>
                                      </div>
                                    </div>
          
                                    <div class="row" style="margin-top:1em">
                                      <button class="ui button primary" id="limit-stop-satis-emri">Satış Emri Gir</button>
                                    </div>

                                </div>
                              </div>

                          
                        </div>
    
                  </div>


              </div>

      </div>
      <div class="eight wide column">
        <div class="ui segment">


          <div class="ui grid">

              <div class="eight wide column">
              
              <h4>ALIŞLAR</h4>

                  <table class="ui very basic collapsing celled table" style="width:100%" id="asks-table">
                    <thead>
                      <th>ID</th>
                      <th>Miktar (BTC)</th>
                      <th>Fiyat (TRY)</th>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3">Henüz bir emir yok.</td>
                        </tr>
                    </tbody>
                  </table>

                </div>
                <div class="eight wide column">

                    <h4>SATIŞLAR</h4>

                    <table class="ui very basic collapsing celled table" style="width:100%" id="bids-table">
                        <thead>
                          <th>ID</th>
                          <th>Fiyat (TRY)</th>
                          <th>Miktar (BTC)</th>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3">Henüz bir emir yok.</td>
                              </tr>
                        </tbody>
                      </table>

                  </div>

          </div>
        </div>
      </div>
      <div class="four wide column">
          <div class="ui segment">
           
              <table class="ui very basic collapsing celled table" style="width:100%" id="fill-table">
                  <thead>
                    <th>Süre</th>
                    <th>Fiyat</th>
                    <th>Miktar</th>
                  </thead>
                  <tbody>
                      <tr>
                          <td colspan="3">henüz işlem gerçekleşmedi.</td>
                      </tr>
                  </tbody>
                </table>

          </div>
        </div>

    </div>
  </div>

  <script>

  var url = 'ws://' + window.location.host + '/book';
  var c = new WebSocket(url);
  var msecPerMinute = 1000 * 60;
  var msecPerHour = msecPerMinute * 60;

  $('.menu .item').tab();

  function sendOrder(side, type, amount, price, easy, trigger, stop){
  
    req = JSON.stringify({
        side: side,
        type: type,
        amount: amount,
        price:price,
        easy: easy,
        trigger: trigger,
        stop: stop,
    });

    $.ajax({
      url : "/add",
      type: "post",
      data: req,
      dataType: "json",
      contentType: "application/json",
      success: function(data, status){
          //alert("Data: " + data + "\nStatus: " + status);
      }
    });

  }

  $('#piyasa-alis-emri').click(function (){
  
    miktar = $('#piyasa-alis-try').val();

    sendOrder("ask","market", miktar, "0", true,"0", false);

  });

  $('#piyasa-satis-emri').click(function (){
  
    miktar = $('#piyasa-satis-btc').val();
    sendOrder("bid","market", miktar, "0", false, "0", false);
  
  });

  $('#limit-alis-emri').click(function (){  
    miktar = $('#limit-alis-miktar').val();
    fiyat = $('#limit-alis-fiyat').val();

    sendOrder("ask","limit", miktar, fiyat, false, "0", false);
  });

  $('#limit-satis-emri').click(function (){
    miktar = $('#limit-satis-miktar').val();
    fiyat = $('#limit-satis-fiyat').val();

    sendOrder("bid","limit", miktar, fiyat, false, "0", false);
  });

  $('#limit-stop-alis-emri').click(function (){

    trigger = $('#limit-stop-alis-trigger').val();
    price = $('#limit-stop-alis-fiyat').val();
    miktar = $('#limit-stop-alis-miktar').val();

    sendOrder("ask","limit", miktar, price, false, trigger, true);

  });

  $('#limit-stop-satis-emri').click(function (){

    trigger = $('#limit-stop-satis-trigger').val();
    price = $('#limit-stop-satis-fiyat').val();
    miktar = $('#limit-stop-satis-miktar').val();

    sendOrder("bid","limit", miktar, price, false, trigger, true);
  });

  $('#piyasa-stop-alis-emri').click(function (){
    trigger = $('#piyasa-stop-alis-trigger').val();
    miktar = $('#piyasa-stop-alis-miktar').val();

    sendOrder("ask","market", miktar, "0", true, trigger, true);
  });

  $('#piyasa-stop-satis-emri').click(function (){

    trigger = $('#piyasa-stop-satis-trigger').val();
    miktar = $('#piyasa-stop-satis-miktar').val();

    sendOrder("bid","market", miktar, "0", false, trigger, true);
  });

  c.onmessage = function(msg) {
    flush(msg);
  };

  function flush(msg){
      var now = new Date();
      asktbl = "";
      bidtbl = "";
      filltbl = "";

      console.debug(msg.data);
      data = JSON.parse(msg.data);

      $.each(data.asks, function (k, v) {
        asktbl += "<tr>";
          asktbl += "<td>" + v.id +"</td>";
          asktbl += "<td>" + v.amount +"</td>";
          asktbl += "<td>" + v.price +"</td>";
        asktbl += "</tr>";
      });

      $.each(data.bids, function (k, v) {
        bidtbl += "<tr>";
          bidtbl += "<td>" + v.id +"</td>";
          bidtbl += "<td>" + v.price +"</td>";
        bidtbl += "<td>" + v.amount +"</td>";
        bidtbl += "</tr>";
      });

      $.each(data.fills, function (k, v) {
        currtime = new Date(v.time);
        interval =  now.getTime() - currtime;
        var minutes = Math.floor(interval / msecPerMinute );

        filltbl += "<tr>";
        filltbl += "<td>" + minutes +"dk</td>";
        filltbl += "<td>" + v.price +"</td>";
        filltbl += "<td>" + v.amount +"</td>";
        filltbl += "</tr>";
      });

      if (asktbl != ""){
        $("#asks-table > tbody").html(asktbl);
      }

      if (bidtbl != ""){
        $("#bids-table > tbody").html(bidtbl);
      }

      if(filltbl != ""){
        $("#fill-table > tbody").html(filltbl);
      }
   }
  </script>

</body>
</html>